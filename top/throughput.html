<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Cache-Control" content="no-cache">
		
		<title>dialog</title>
		
		<style>
@import "/css/style.css";

		</style>
		
		<script>
		</script>
	</head>
	
	<body class="loading">
        <div class="bg_loading"></div>
		
		<script>
var
    resourceData = {},
    idMap = {};
    resourceMap = {};
const
    ifInOctets = "1.3.6.1.2.1.2.2.1.10",
    ifOutOctets = "1.3.6.1.2.1.2.2.1.16",
    ifHCInOctets = "1.3.6.1.2.1.31.1.1.1.6",
    ifHCOutOctets = "1.3.6.1.2.1.31.1.1.1.10",
    ifSpeed = "1.3.6.1.2.1.2.2.1.5",
    ifHighSpeed = "1.3.6.1.2.1.31.1.1.1.15";

function sortValue(indexData) {
    var speed;
    
    if ((speed = indexData[ifHighSpeed]) || (speed = indexData[ifSpeed])) {
        speed = Number(speed.value);
    } else {
        return -1;
    }

    if (speed === undefi) {
        return -1;
    }

    var inOct = ifHCInOctets in indexData? Number(indexData[ifHCInOctets].value): ifHCInOctets in indexData? Number(indexData[ifHCInOctets].value): undefined;

}

function sortNode(nodeData) {
    var indexData;
    Object.keys(nodeData).sort(indexA, indexB =>{
        return sortValue(nodeData[indexB]) - sortValue(nodeData[indexA]);
    });
}

function sort(resourceData) {
    if (!old) {
        old = resourceData;
    }
    
    Object.keys(resourceData).sort(idA, idB => {
        return sortNode(resourceData[idB]) - sortNode(resourceData[idA]);
    });
}

function parseThroughput(id, index, oidData) {
    var speed, inOct, outOct, timestamp, value;
    
    try {
        indexData = window.resourceData[id][index];
    } catch(e) {
        return;
    }

    if ((speed = indexData[ifHighSpeed]) || (speed = indexData[ifSpeed])) {
        speed = Number(speed.value);
console.log(speed);
        if (speed <= 0) {
            return;
        }
    } else {
        return;
    }

    if ((inOct = indexData[ifHCInOctets]) || (inOct = indexData[ifInOctets])) {
        timestamp = inOct.timestamp;
        value = Number(inOct.value);

        if ("inOct" in window.resourceData[id][index]) {
            var
                old = window.resourceData[id][index].inOct,
                elapse = old.timestamp - timestamp;

            if (elapse > 0) {
                window.idMap[id][index].inBPS = (value - old.value) /elapse *8000;
            }
        }
    } else {
        return;
    }

    if ((outOct = indexData[ifHCOutOctets]) || (outOct = indexData[ifOutOctets])) {
        timestamp = outOct.timestamp;
        value = Number(outOct.value);

        if ("outOct" in window.resourceData[id][index]) {
            var
                old = window.resourceData[id][index].outOct,
                elapse = old.timestamp - timestamp;
            if (elapse > 0) {
                window.idMap[id][index].outBPS = (value - old.value) /elapse *8000;
            }
        }
    } else {
        return;
    }
}

function parseResource(id, index, oidData) {
    parseThroughput(id, index, oidData);
}

function parse(resourceData) {
    var indexData, oidData;

    for (let id in resourceData) {
        indexData = resourceData[id];

        if (!(id in window.idMap)) {
            window.idMap[id] = {};
        }

        for (let index in indexData) {
            if (!(index in window.idMap[id])) {
                window.idMap[id][index] = {};
            }

            parseResource(id, index, indexData[index]);
        }
    }

    window.resourceData = resourceData;

    console.log(window.idMap);
    console.log(window.resourceData);
/*
    for (let id in window.idMap) {
        let indexData = window.idMap[id];

        for (let index in indexData) {
            console.log(id, index, indexData[index]);
        }
    }*/
}

var i=0;
function requestResource() {
    top.postRequest({
        command: "get",
        target: "resource"
    }, function () {
        switch (this.status) {
        case 200:
            parse(JSON.parse(this.responseText));
        break;

        default:
            alert(top.getMessage(this.status));

            console.log(this.responseText && JSON.parse(this.responseText).error);
        }

        if (i++ == 0) {
            setInterval(requestResource, 10000);
        }
    });
}

requestResource();

</script>
	
	</body>
	
</html>